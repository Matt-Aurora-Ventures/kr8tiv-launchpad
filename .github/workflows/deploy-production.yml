# Production Deployment Pipeline
# Deploys to production on merge to main

name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        required: false
        default: 'false'
        type: boolean
      deploy_api:
        description: 'Deploy API'
        required: false
        default: 'true'
        type: boolean
      deploy_web:
        description: 'Deploy Web'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================
  # Pre-flight Checks
  # ============================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for deployment-worthy changes
        id: check
        run: |
          # Always deploy on manual trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If this is the first commit, deploy by default
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "First commit detected - deploying"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if changes affect deployable code
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -qE '^(apps/|packages/|programs/)'; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "No deployable changes detected"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Run Tests (unless skipped)
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [preflight]
    if: needs.preflight.outputs.should-deploy == 'true' && github.event.inputs.skip_tests != 'true' && vars.RUN_PROD_TESTS == 'true'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: kr8tiv_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check database configuration
        id: check-db
        run: |
          if [[ -n "${{ secrets.PRODUCTION_DATABASE_URL }}" ]]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::PRODUCTION_DATABASE_URL not configured - skipping migrations"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate --workspace=apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/kr8tiv_test

      - name: Run All Tests
        run: npm run test
        env:
          CI: true
          DATABASE_URL: postgresql://test:test@localhost:5432/kr8tiv_test

  # ============================================
  # Database Migrations
  # ============================================
  migrate:
    name: Database Migrations
    runs-on: ubuntu-latest
    needs: [preflight, test]
    if: |
      always() &&
      needs.preflight.outputs.should-deploy == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Prisma Migrations
        if: steps.check-db.outputs.configured == 'true'
        run: npx prisma migrate deploy --schema=apps/api/prisma/schema.prisma
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

      - name: Verify migration
        if: steps.check-db.outputs.configured == 'true'
        run: npx prisma db pull --schema=apps/api/prisma/schema.prisma --force
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}

  # ============================================
  # Deploy Web to Vercel Production
  # ============================================
  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: [preflight, test, migrate]
    if: |
      always() &&
      needs.preflight.outputs.should-deploy == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.migrate.result == 'success' || needs.migrate.result == 'skipped') &&
      github.event.inputs.deploy_web != 'false'
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Vercel configuration
        id: check-vercel
        run: |
          if [[ -n "${{ secrets.VERCEL_TOKEN }}" ]] && [[ -n "${{ secrets.VERCEL_ORG_ID }}" ]] && [[ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::Vercel secrets not configured - skipping web deploy"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Vercel CLI
        if: steps.check-vercel.outputs.configured == 'true'
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        if: steps.check-vercel.outputs.configured == 'true'
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        if: steps.check-vercel.outputs.configured == 'true'
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL }}
          NEXT_PUBLIC_SOLANA_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
          NEXT_PUBLIC_KR8TIV_MINT: ${{ secrets.KR8TIV_TOKEN_MINT }}
          NEXT_PUBLIC_STAKING_PROGRAM_ID: ${{ secrets.STAKING_PROGRAM_ID }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: Deploy to Vercel Production
        id: deploy
        if: steps.check-vercel.outputs.configured == 'true'
        run: |
          URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

  # ============================================
  # Deploy API to Railway/Render
  # ============================================
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [preflight, test, migrate]
    if: |
      always() &&
      needs.preflight.outputs.should-deploy == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.migrate.result == 'success' || needs.migrate.result == 'skipped') &&
      github.event.inputs.deploy_api != 'false'
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check API deployment configuration
        id: check-api
        run: |
          if [[ -n "${{ secrets.RAILWAY_TOKEN }}" ]] && [[ -n "${{ secrets.RAILWAY_PROJECT_ID }}" ]]; then
            echo "railway=true" >> $GITHUB_OUTPUT
          else
            echo "railway=false" >> $GITHUB_OUTPUT
            echo "::notice::Railway secrets not configured - skipping Railway deploy"
          fi
          if [[ -n "${{ secrets.RENDER_API_KEY }}" ]] && [[ -n "${{ secrets.RENDER_SERVICE_ID }}" ]]; then
            echo "render=true" >> $GITHUB_OUTPUT
          else
            echo "render=false" >> $GITHUB_OUTPUT
            echo "::notice::Render secrets not configured - skipping Render deploy"
          fi

      - name: Setup Node.js
        if: steps.check-api.outputs.railway == 'true' || steps.check-api.outputs.render == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        if: steps.check-api.outputs.railway == 'true' || steps.check-api.outputs.render == 'true'
        run: npm ci

      - name: Build API
        if: steps.check-api.outputs.railway == 'true' || steps.check-api.outputs.render == 'true'
        run: npm run build --workspace=apps/api

      # Railway deployment
      - name: Deploy to Railway
        if: steps.check-api.outputs.railway == 'true'
        id: deploy
        run: |
          npm install -g @railway/cli
          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }}
          URL=$(railway up --environment production --json | jq -r '.url')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # Alternative: Render deployment
      - name: Deploy to Render
        if: steps.check-api.outputs.railway == 'false' && steps.check-api.outputs.render == 'true'
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "do_not_clear"}' \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys"

  # ============================================
  # Health Checks
  # ============================================
  health-check:
    name: Health Checks
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-api]
    if: always() && (needs.deploy-web.result == 'success' || needs.deploy-api.result == 'success')
    steps:
      - name: Wait for services to stabilize
        run: sleep 60

      - name: Check Web Health
        if: needs.deploy-web.result == 'success' && needs.deploy-web.outputs.url != ''
        run: |
          echo "Checking web health..."
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy-web.outputs.url }}")
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Web is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
          done
          echo "Web health check failed"
          exit 1

      - name: Check API Health
        if: needs.deploy-api.result == 'success' && needs.deploy-api.outputs.url != ''
        run: |
          echo "Checking API health..."
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy-api.outputs.url }}/health")
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "API is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
          done
          echo "API health check failed"
          exit 1

      - name: Smoke Test - Key Endpoints
        if: needs.deploy-api.result == 'success'
        run: |
          API_URL="${{ needs.deploy-api.outputs.url }}"
          if [[ -n "$API_URL" ]]; then
            # Test health endpoint
            curl -sSf "$API_URL/health" || exit 1

            # Test API version/info endpoint (if exists)
            curl -sSf "$API_URL/api/v1/info" || echo "Info endpoint not available"
          fi

  # ============================================
  # Post-Deploy Notifications
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-api, health-check]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.health-check.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=#36a64f" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=#ff0000" >> $GITHUB_OUTPUT
          fi

      - name: Check Slack configuration
        id: check-slack
        run: |
          if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::SLACK_WEBHOOK_URL not configured - skipping Slack notification"
          fi

      - name: Notify Slack (Success)
        if: steps.status.outputs.status == 'success' && steps.check-slack.outputs.configured == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":white_check_mark: *Production Deployment Successful*\n\n*Repository:* ${{ github.repository }}\n*Commit:* `${{ github.sha }}`\n*Web:* ${{ needs.deploy-web.outputs.url }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack (Failure)
        if: steps.status.outputs.status == 'failure' && steps.check-slack.outputs.configured == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":x: *Production Deployment Failed*\n\n*Repository:* ${{ github.repository }}\n*Commit:* `${{ github.sha }}`\n*Run:* <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Deployment Status
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const webUrl = '${{ needs.deploy-web.outputs.url }}';

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 1,
              state: status === 'success' ? 'success' : 'failure',
              environment_url: webUrl,
              description: status === 'success'
                ? 'Deployment completed successfully'
                : 'Deployment failed - check logs'
            });

  # ============================================
  # Rollback (Manual Trigger)
  # ============================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    needs: [health-check]
    steps:
      - name: Rollback Vercel
        run: |
          echo "To rollback Vercel deployment, visit:"
          echo "https://vercel.com/${{ secrets.VERCEL_ORG_ID }}/${{ secrets.VERCEL_PROJECT_ID }}/deployments"
          echo ""
          echo "Or use: vercel rollback --token=$VERCEL_TOKEN"

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production Deployment Failed - Rollback Required`,
              body: `## Production Deployment Failed

              **Commit:** \`${{ github.sha }}\`
              **Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

              ### Action Required
              1. Check the workflow logs for failure details
              2. Rollback if necessary via Vercel dashboard
              3. Fix the issue and re-deploy

              ### Rollback Commands
              \`\`\`bash
              # Vercel rollback
              vercel rollback --yes

              # Or restore previous deployment
              git revert HEAD
              git push origin main
              \`\`\`
              `,
              labels: ['urgent', 'deployment', 'production']
            });
